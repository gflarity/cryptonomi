
<title>File API (simple)</title>
<article>
  <p id="status">File API &amp; FileReader API not supported</p>
  <p><input type=file></p>
  <p>Select an image from your machine to read the contents of the file without using a server</p>
  <div id="holder"></div>
</article>
<script type="text/javascript" src="2.5.3-crypto-min.js"></script>
<script src="aes.js"></script>
<script src="FileSaver.js"></script>
<script>
var upload = document.getElementsByTagName('input')[0],
    holder = document.getElementById('holder'),
    state = document.getElementById('status');

if (typeof window.FileReader === 'undefined') {
  state.className = 'fail';
} else {
  state.className = 'success';
  state.innerHTML = 'File API & FileReader available';
}
 
upload.onchange = function (e) {
  e.preventDefault();

  var file = upload.files[0],
      reader = new FileReader();


reader.onload = function (event) {
    if ( event.target.result ) {
       var original_ab = event.target.result;
        
     var original_ab = event.target.result;
        
        var original_uint8 = new Uint8Array( original_ab );
        var original_string = Crypto.charenc.Binary.bytesToString(original_uint8);
    
        //console.log( "original: " + original );
        var encrypted = Aes.Ctr.encrypt( original_string, "password", 256 );
        //console.log( "encrypted: " + encrypted );
        var decrypted_string = Aes.Ctr.decrypt( encrypted, "password", 256 );
        //console.log( "decrypted: " + decrypted );
        var decrypted_bytes = Crypto.charenc.Binary.stringToBytes(decrypted_string);

        var decrypted_bytes_ab = new ArrayBuffer( decrypted_bytes.length );
        var decrypted_bytes_view = new Uint8Array( decrypted_bytes_ab );
        
        for ( var i = 0; i < decrypted_bytes.length; i++ ) {
            decrypted_bytes_view[i] = decrypted_bytes[i];
        }
        
        var bb = new BlobBuilder;
        bb.append( decrypted_bytes_ab );
        window.saveAs( bb.getBlob() );
        
    }
  };
  reader.onprogress = function( event ) {
      
    console.log(event);    
    
  };
  reader.readAsArrayBuffer(file);

  return false;
};
</script>

