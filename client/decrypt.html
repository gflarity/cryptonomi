
<title>File API (simple)</title>
<article>
  <p id="status">File API &amp; FileReader API not supported</p>
  <button id="download_button">Download</button>
  <p>Enter a password: <input type=password> <button type="button">Decrypt</button></p>
  <div id="holder"></div>
  <progress id='decryption_progress' min="0" max="1000" value="0" style="width:500px;">0% complete</progress>
</article>
<script type="text/javascript" src="/cryptonomi.js"></script>

<script type="text/javascript" src="/node_modules/eventemitter2/lib/eventemitter2.js"></script>
<script type="text/javascript" src="/webworker_bridge_emitter.js"></script>
<script type="text/javascript" src="/aes.js"></script>
<script type="text/javascript" src="/core.js"></script>

<script src="/FileSaver.js"></script>
<script>
var state = document.getElementById('status')
var worker = new Worker('/cryptoworker.js')
var bridge = new EEWWBridge( worker )

var downloadButton = document.getElementById('download_button')
downloadButton.onclick= function( event ) {
    var xhr = new XMLHttpRequest();  
    var hrefSplit = window.location.href.split(/\//)
    var guid =hrefSplit[hrefSplit.length - 1]        
    var url = '/download/' + guid
    xhr.open('GET', url, true);
    xhr.responseType = 'arraybuffer';
    xhr.onload = function(e) {
         if (this.status == 200) {
            arrayBuffer = this.response
            var onDecrypted = function( payload ) {
                console.log( payload )    
            };
            bridge.on( 'decrypted', onDecrypted )            

            var onProgress = function( value ) {    
                var progressBar = document.getElementById('decryption_progress')
                progressBar.value = value;
            };

           bridge.on( 'progress', onProgress )
           bridge.pass( 'decrypt', { arrayBuffer : arrayBuffer, password : 'password' }, [ arrayBuffer ] )
        }
    };
    xhr.send();
};

bridge.on( 'console.log', function( value ) { console.log( value ) } );

if (typeof window.FileReader === 'undefined') {
    state.className = 'fail';
}
else {
    state.className = 'success';
    state.innerHTML = 'File API & FileReader available';
}

</script>

