
<title>File API (simple)</title>
<article>
  <p id="status">File API &amp; FileReader API not supported</p>
  <p>Select a file to be encrypted: <input type=file></p>
  <p>Enter a password: <input type=password></p>
  <div id="holder"></div>
<ul id="filelist"></ul>

</article>
<script type="text/javascript" src="2.5.3-crypto-min.js"></script>
<script type="text/javascript" src="cryptonomi.js"></script>
<script src="aes.js"></script>

<script src="aes.js"></script>
<script src="FileSaver.js"></script>
<script>
var upload = document.getElementsByTagName('input')[0],
    holder = document.getElementById('holder'),
    state = document.getElementById('status');

if (typeof window.FileReader === 'undefined') {
    state.className = 'fail';
}
else {
    state.className = 'success';
    state.innerHTML = 'File API & FileReader available';
}

upload.onchange = function(e) {
    e.preventDefault();
    var file = upload.files[0];
    
    console.log( "saving "  + file.fileName + " to sandbox" );
    var start = new Date().getTime();
    var onFileSaved = function( err ) {
        var end = new Date().getTime();
        console.log("saved in: " + (end-start) );
    };
    cryptonomi.saveFile( file,  onFileSaved );    
};


function errorHandler(e) {
  var msg = '';

  switch (e.code) {
    case FileError.QUOTA_EXCEEDED_ERR:
      msg = 'QUOTA_EXCEEDED_ERR';
      break;
    case FileError.NOT_FOUND_ERR:
      msg = 'NOT_FOUND_ERR';
      break;
    case FileError.SECURITY_ERR:
      msg = 'SECURITY_ERR';
      break;
    case FileError.INVALID_MODIFICATION_ERR:
      msg = 'INVALID_MODIFICATION_ERR';
      break;
    case FileError.INVALID_STATE_ERR:
      msg = 'INVALID_STATE_ERR';
      break;
    default:
      msg = 'Unknown Error';
      break;
  };

  console.log('Error: ' + msg);
}

function toArray(list) {
  return Array.prototype.slice.call(list || [], 0);
}

function listResults(entries) {
  // Document fragments can improve performance since they're only appended
  // to the DOM once. Only one browser reflow occurs.
  var fragment = document.createDocumentFragment();

  entries.forEach(function(entry, i) {
    var img = entry.isDirectory ? '<img src="folder-icon.gif">' :
                                  '<img src="file-icon.gif">';
    var li = document.createElement('li');
    li.innerHTML = [img, '<span>', entry.name, '</span>'].join('');
    fragment.appendChild(li);
  });

  document.querySelector('#filelist').appendChild(fragment);
}

function onInitFs(fs) {

  var dirReader = fs.root.createReader();
  var entries = [];

  // Call the reader.readEntries() until no more results are returned.
  var readEntries = function() {
     dirReader.readEntries (function(results) {
      if (!results.length) {
        listResults(entries.sort());
      } else {
        for ( i = 0; i < results.length; i++ ) {           
            results[i].remove( function() { 
                console.log( "removed something" ) } );
        } 
      }        
    }, errorHandler);
  };

  readEntries(); // Start reading dirs.

}

 
//cryptonomi.clearFS( function() {  
    window.requestFileSystem(window.TEMPORARY, 1024*1024, onInitFs, errorHandler);
//} );
</script>

